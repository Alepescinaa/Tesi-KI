---
title: "Performance Comparison"
author: "Alessandra Pescina"
date: "2024-12-16"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, results='hide'}


knitr::opts_chunk$set(
  echo = FALSE,           
  warning = FALSE,      
  message = FALSE,       
  fig.align = "center",  
  fig.width = 12,        
  fig.height = 8,        
  out.width = "100%"     
)



```



```{r}
library(fs)
library(parallel)
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(here)
library(kableExtra)
library(plotly)
```

```{r, results='hide'}
setwd(here())

path <- "./wrapper_MM/plots_500/"
files <- list.files(path, pattern = "\\.RData$", full.names = TRUE)
lapply(files, load, .GlobalEnv)

conv_table500 <- conv_table
remove(conv_table)

mean_ct500 <- mean_ct
remove(mean_ct)

plots_bias500 <- plots_bias
remove(plots_bias)

plots_cov500 <- plots_cov
remove(plots_cov)

plots_errorI500 <- plots_errorI
remove(plots_errorI)

plots_power500 <- plots_power
remove(plots_power)

plots_distr500 <- plots_distr
remove(plots_distr)

plfe500 <- plfe
remove(plfe)


```

```{r, results='hide'}
path <- "./wrapper_MM/plots_2K/"
files <- list.files(path, pattern = "\\.RData$", full.names = TRUE)
lapply(files, load, .GlobalEnv)

conv_table2K <- conv_table
remove(conv_table)

mean_ct2K <- mean_ct
remove(mean_ct)

plots_bias2K <- plots_bias
remove(plots_bias)

plots_cov2K <- plots_cov
remove(plots_cov)

plots_errorI2K <- plots_errorI
remove(plots_errorI)

plots_power2K <- plots_power
remove(plots_power)

plots_distr2K <- plots_distr
remove(plots_distr)

plfe2K <- plfe
remove(plfe)



```

```{r, results='hide'}
path <- "./wrapper_MM/plots_5K/"
files <- list.files(path, pattern = "\\.RData$", full.names = TRUE)
lapply(files, load, .GlobalEnv)

conv_table5K <- conv_table
remove(conv_table)

mean_ct5K <- mean_ct
remove(mean_ct)

plots_bias5K<- plots_bias
remove(plots_bias)

plots_cov5K <- plots_cov
remove(plots_cov)

plots_errorI5K <- plots_errorI
remove(plots_errorI)

plots_power5K <- plots_power
remove(plots_power)

plots_distr5K <- plots_distr
remove(plots_distr)

plfe5K <- plfe
remove(plfe)

```

```{r, results='hide'}
path <- "./wrapper_MM/plots_10K/"
files <- list.files(path, pattern = "\\.RData$", full.names = TRUE)
lapply(files, load, .GlobalEnv)

conv_table10K <- conv_table
remove(conv_table)

mean_ct10K <- mean_ct
remove(mean_ct)

plots_bias10K<- plots_bias
remove(plots_bias)

plots_cov10K <- plots_cov
remove(plots_cov)

plots_errorI10K <- plots_errorI
remove(plots_errorI)

plots_power10K <- plots_power
remove(plots_power)

plots_distr10K <- plots_distr
remove(plots_distr)

plfe10K <- plfe
remove(plfe)

```

## Plots: 500 observations

### Bias of estimates 


1st version \n
Remark: I have inserted the error bar associated to the bias but most of the times the distribution is mostly centered around the mean so is not visible

```{r}
p1 <- plots_bias500[[1]] + labs(title= "1 year observation scheme")
p2 <- plots_bias500[[3]] + labs(title= "3 years observation scheme")
p3 <- plots_bias500[[5]] + labs(title= "3-6 years observation scheme")
p4 <- plots_bias500[[7]] + labs(title= "irregular observation scheme")
bias_500 <- (p1+p2) / (p3+p4) + plot_layout(guides = "collect")
bias_500 &
  ylim(0, 4)


```

### Bias of estimates

2nd version\n
Pro: unique plot, easier to compare trends between different observation schemes\n
Cons: sometimes more difficult to highlight trend of different models in same obs scheme\n
I am gonna keep this for next plots


```{r}

p1 <- plots_bias500[[1]]$data
p2 <- plots_bias500[[3]]$data
p3 <- plots_bias500[[5]]$data
p4 <- plots_bias500[[7]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years "
p3$scenario <- "3-6 years "
p4$scenario <- "irregular "

df_all <- rbind(p1,p2,p3,p4)
latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
  )



 ggplot(data = df_all, aes(x = model, y = bias_mean, color = scenario)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "free_y", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels))) + 
  
  labs(title = NULL, 
       x = "Model", 
       y = "Bias",
       color = "Observation Scheme") + 
  
  geom_line(aes(group = scenario), size = 1, linetype = "solid", alpha = 0.8) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", size = 1) + 
  #geom_errorbar(aes(ymin = bias_lower, ymax = bias_upper), width = 0.3, color = "black") + 
  
   
  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        plot.caption = element_text(hjust = 0, size = 8)) + 
  
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)

 ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/bias500.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
 
```



### Coverage of estimates 

```{r, warning=FALSE}
p1 <- plots_cov500[[1]] + labs(title= "1 year observation scheme")
p2 <- plots_cov500[[2]] + labs(title= "3 years observation scheme")
p3 <- plots_cov500[[3]] + labs(title= "3-6 years observation scheme")
p4 <- plots_cov500[[4]] + labs(title= "irregular observation scheme")


cov_500 <- (p1+p2) / (p3+p4) + plot_layout(guides = "collect") 
cov_500
```

# This includes all possibles combination of convergence we would like to observe
```{r}

q1 <- plots_cov500[[1]]$data
q2 <- plots_cov500[[2]]$data
q3 <- plots_cov500[[3]]$data
q4 <- plots_cov500[[4]]$data

q1$scenario <- "1 year"
q2$scenario <- "3 years"
q3$scenario <- "3-6 years"
q4$scenario <- "irregular"

q1$size <- 500
q2$size <- 500
q3$size <- 500
q4$size <- 500

p1 <- plots_cov2K[[1]]$data
p2 <- plots_cov2K[[2]]$data
p3 <- plots_cov2K[[3]]$data
p4 <- plots_cov2K[[4]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

p1$size <- 2000
p2$size <- 2000
p3$size <- 2000
p4$size <- 2000

r1 <- plots_cov5K[[1]]$data
r2 <- plots_cov5K[[2]]$data
r3 <- plots_cov5K[[3]]$data
r4 <- plots_cov5K[[4]]$data

r1$scenario <- "1 year"
r2$scenario <- "3 years"
r3$scenario <- "3-6 years"
r4$scenario <- "irregular"

r1$size <- 5000
r2$size <- 5000
r3$size <- 5000
r4$size <- 5000

f1 <- plots_cov10K[[1]]$data
f2 <- plots_cov10K[[2]]$data
f3 <- plots_cov10K[[3]]$data
f4 <- plots_cov10K[[4]]$data

f1$scenario <- "1 year"
f2$scenario <- "3 years"
f3$scenario <- "3-6 years"
f4$scenario <- "irregular"

f1$size <- 10000
f2$size <- 10000
f3$size <- 10000
f4$size <- 10000

df_all <- rbind(q1,q2,q3,q4, p1,p2,p3,p4,r1,r2,r3,r4,f1,f2,f3,f4)
df_all$size <- as.factor(df_all$size)
df_all <- subset(df_all, parameter %in% c("cov1", "cov2", "cov3"))
df_all <- df_all[df_all$size %in% c("5000"),]
#df_all <- df_all[df_all$scenario %in% c("1 year"),]

latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
)


ggplot(data = df_all, aes(x = model, y = coverage_mean, color = scenario)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "free_y", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels))) +
 
  
  labs(title = NULL, 
       x = "Model", 
       y = "Coverage (%)",
       color = "Observation Scheme") + 
  
  geom_line(aes(group = scenario), size = 1, linetype = "dashed", alpha = 0.8) + 
  geom_hline(yintercept = 95, linetype = "dashed", color = "grey50", size = 1) + 
  
  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        plot.caption = element_text(hjust = 0, size = 8)) + 
  
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)

 ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/convergence.pdf", 
        width = 8, height = 6, units = "in", dpi = 300)

```


### Error type I in different models 

1st version\n
Pro: more aesthetic\n
Cons: difficult to detect which dots belong to which model

```{r}
p1 <- plots_errorI500[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[1]]$data
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4)
df1$scenario <- factor(df1$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )

p1 <- plots_errorI500[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[2]]$data
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4)
df2$scenario <- factor(df2$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )




ggplot(df1, aes(x = model, y = power_category, color = scenario)) +
  geom_point(size = 4, position = position_dodge(width = 0.7)) +
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)+
  labs(
    title = "Error type I by Observation scheme",
    subtitle ="Transition from Dementia-free to Dementia",
    x = "Model",
    y = NULL,
    color = "Observation scheme",
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.position = "top"
  )

ggplot(df2, aes(x = model, y = power_category, color = scenario)) +
  geom_point(size = 4, position = position_dodge(width = 0.7)) +
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)+
  labs(
    title = "Error type I by Observation scheme",
    subtitle = "Transition from Dementia to Death",
    x = "Model",
    y = NULL,
    color = "Observation scheme",
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.position = "top"
  )
```


### Error type I in different models 

2nd version\n
Pro: easier to interpret and intuitive \n
Cons:I am not convinced by the bars\n
I am gonna keep this version for next plots

```{r}

p1 <- plots_errorI500[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[1]]$data
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4)
df1$scenario <- factor(df1$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )

p1 <- plots_errorI500[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[2]]$data
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4)
df2$scenario <- factor(df2$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )
df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))


plot1 <- ggplot(df1, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia-free to Dementia",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
 theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )


plot2 <- ggplot(df2, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia to Death",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  

combined_plot_error500 <- (plot1 | plot2) +plot_layout(guides = 'collect')

combined_plot_error500 & 
  plot_annotation( title = "Type I Error by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))

 
```

# This includes all possibles combination of error type I we would like to observe

```{r}
p1 <- plots_errorI500[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[1]]$data
p4$scenario <- "irregular"
df1 <- rbind(p1,p2,p3,p4)
df1$size <- "500 individuals"

p1 <- plots_errorI2K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI2K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI2K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI2K[[4]][[1]]$data
p4$scenario <- "irregular"
df2 <- rbind(p1,p2,p3,p4)
df2$size <- "2000 individuals"


p1 <- plots_errorI5K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI5K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI5K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI5K[[4]][[1]]$data
p4$scenario <- "irregular"
df3 <- rbind(p1,p2,p3,p4)
df3$size <- "5000 individuals"


p1 <- plots_errorI10K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI10K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI10K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI10K[[4]][[1]]$data
p4$scenario <- "irregular"
df4 <- rbind(p1,p2,p3,p4)
df4$size <- "10000 individuals"

df_all <- rbind(df1,df2,df3,df4)
df_all$scenario <- factor(df_all$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df_all<- df_all %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )
df_all<- df_all %>%
  mutate(
    size = factor(size, levels = c("500 individuals", "2000 individuals", "5000 individuals","10000 individuals"))
  )


plot1 <- ggplot(df_all, aes(x = model, y = scenario, fill = power_category)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  scale_fill_viridis_d(option = "D", begin = 0.85, end = 0.2)+
  # scale_fill_manual(
  #   values = c(
  #     "Low (<5%)" = "#8BC34A",  # Muted olive green
  #     "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
  #     "High (>10%)" = "#E57373"  # Soft coral red
  #   )
  # ) + 
  facet_wrap(~ size, nrow = 2, ncol = 2, strip.position = "top") + 
  labs(
    title = NULL,  # from Dementia-free to Dementia
    x = "Model",
    y = "Observation scheme",
    fill = "Type I Error"
  ) + 
  theme_minimal() + 
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),  # Show y-axis labels
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    strip.text = element_text(size = 12,  color = "black"),  # Facet labels in bold
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10),  # Add spacing around the plot
    panel.grid = element_blank(),  
    panel.background = element_blank()  
  )

plot1

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/errortypeI_Beta1.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
 
```

```{r}
p1 <- plots_errorI500[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI500[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI500[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI500[[4]][[2]]$data
p4$scenario <- "irregular"
df1 <- rbind(p1,p2,p3,p4)
df1$size <- "500 individuals"

p1 <- plots_errorI2K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI2K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI2K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI2K[[4]][[2]]$data
p4$scenario <- "irregular"
df2 <- rbind(p1,p2,p3,p4)
df2$size <- "2000 individuals"


p1 <- plots_errorI5K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI5K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI5K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI5K[[4]][[2]]$data
p4$scenario <- "irregular"
df3 <- rbind(p1,p2,p3,p4)
df3$size <- "5000 individuals"


p1 <- plots_errorI10K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI10K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI10K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI10K[[4]][[2]]$data
p4$scenario <- "irregular"
df4 <- rbind(p1,p2,p3,p4)
df4$size <- "10000 individuals"

df_all <- rbind(df1,df2,df3,df4)
df_all$scenario <- factor(df_all$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df_all<- df_all %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )
df_all<- df_all %>%
  mutate(
    size = factor(size, levels = c("500 individuals", "2000 individuals", "5000 individuals","10000 individuals"))
  )


plot1 <- ggplot(df_all, aes(x = model, y = scenario, fill = power_category)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  scale_fill_viridis_d(option = "D", begin = 0.85, end = 0.2)+
  facet_wrap(~ size, nrow = 2, ncol = 2, strip.position = "top") + 
  labs(
    title = NULL,  # from Dementia to Death
    x = "Model",
    y = "Observation scheme",
    fill = "Type I Error"
  ) + 
  theme_minimal() + 
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),  # Show y-axis labels
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    strip.text = element_text(size = 12,  color = "black"),  # Facet labels in bold
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10),  # Add spacing around the plot
    panel.grid = element_blank(),  
    panel.background = element_blank()  
  )

plot1
ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/errortypeI_Beta3.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```


### Power of different models

```{r}
p1 <- plots_power500[[1]]$data
p2 <- plots_power500[[4]]$data
p3 <- plots_power500[[7]]$data
p4 <- plots_power500[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) #dementia-free to dem
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power500[[2]]$data
p2 <- plots_power500[[5]]$data
p3 <- plots_power500[[8]]$data
p4 <- plots_power500[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) #dementia-free to death
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power500[[3]]$data
p2 <- plots_power500[[6]]$data
p3 <- plots_power500[[9]]$data
p4 <- plots_power500[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) #dementia to death
df3 <- df3 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df3$scenario <- factor(df3$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))

latex_labels <- c(
  "beta[1]" = "beta[1]",
  "beta[2]" = "beta[2]",
  "beta[3]" = "beta[3]"
)

create_power_plot <- function(data, subtitle){
  ggplot(data, aes(x = model, y = power_category, fill = power_category)) + 
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y = 1)) +  # Add bar borders
  scale_fill_manual(
    values = c(
      "Low (<50%)" = "#E57373",        
      "Moderate (50%-80%)" = "#FFEB3B",       
      "High (>80%)" =  "#8BC34A"      
    )
  ) + 
  facet_grid(
    scenario ~ covariate, 
    labeller = labeller(covariate = as_labeller(latex_labels, label_parsed)),
    switch ="y"
  ) + 
  labs(
    title = "Power by Model and Observation Scheme",
    subtitle = subtitle,
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )
}

plot1 <- create_power_plot(df1, "Transition from Dementia-free to Dementia") 
plot2 <- create_power_plot(df2, "Transition from Dementia-free to Death")
plot3 <- create_power_plot(df3, "Transition from Dementia to Death")

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot3 <- plot3 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  


combined_plot_power500 <- (plot1 | plot2 | plot3) +plot_layout(guides = 'collect')

combined_plot_power500 & 
  plot_annotation( title = "Power by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5), panel.spacing = unit(2, "cm")))
```
# This includes all possibles combination of error type I we would like to observe

dementia-free to dementia
```{r}
p1 <- plots_power500[[1]]$data
p2 <- plots_power500[[4]]$data
p3 <- plots_power500[[7]]$data
p4 <- plots_power500[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) 
df1$size <- "500 individuals"

p1 <- plots_power2K[[1]]$data
p2 <- plots_power2K[[4]]$data
p3 <- plots_power2K[[7]]$data
p4 <- plots_power2K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) 
df2$size <- "2000 individuals"

p1 <- plots_power5K[[1]]$data
p2 <- plots_power5K[[4]]$data
p3 <- plots_power5K[[7]]$data
p4 <- plots_power5K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) 
df3$size <- "5000 individuals"


p1 <- plots_power10K[[1]]$data
p2 <- plots_power10K[[4]]$data
p3 <- plots_power10K[[7]]$data
p4 <- plots_power10K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df4 <- rbind(p1,p2,p3,p4) 
df4$size <- "10000 individuals"

df_all <- rbind(df1,df2,df3,df4)
df_all <- df_all %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df_all$scenario <- factor(df_all$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))

df_all<- df_all %>%
  mutate(
    size = factor(size, levels = c("500 individuals", "2000 individuals", "5000 individuals","10000 individuals"))
  )

latex_labels <- c(
    "500 individuals"="500 individuals",
    "2000 individuals"="2000 individuals",
    "5000 individuals"="5000 individuals",
    "10000 individuals"="10000 individuals",
    "beta[1]" = "hat(beta)[1]",
    "beta[2]" = "hat(beta)[2]",
    "beta[3]" = "hat(beta)[3]"
  )

plot1 <- ggplot(df_all, aes(x = model, y = scenario, fill = power_category)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  scale_fill_viridis_d(option = "D", begin = 0.2, end = 0.85)+
  facet_grid(rows = vars(covariate), cols = vars(size), 
             labeller = labeller(covariate = as_labeller(latex_labels, label_parsed))) +
  labs(
    title = NULL,  
    x = "Model",
    y = "Observation scheme",
    fill = "Power"
  ) + 
  theme_minimal() + 
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),  # Show y-axis labels
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    strip.text = element_text(size = 12,  color = "black"),  # Facet labels in bold
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10),  # Add spacing around the plot
    panel.grid = element_blank(),  
    panel.background = element_blank()  
  )

plot1

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/powertrans1.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```
```{r}
p1 <- plots_power500[[2]]$data
p2 <- plots_power500[[5]]$data
p3 <- plots_power500[[8]]$data
p4 <- plots_power500[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) 
df1$size <- "500 individuals"

p1 <- plots_power2K[[2]]$data
p2 <- plots_power2K[[5]]$data
p3 <- plots_power2K[[8]]$data
p4 <- plots_power2K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) 
df2$size <- "2000 individuals"

p1 <- plots_power5K[[2]]$data
p2 <- plots_power5K[[5]]$data
p3 <- plots_power5K[[8]]$data
p4 <- plots_power5K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) 
df3$size <- "5000 individuals"


p1 <- plots_power10K[[2]]$data
p2 <- plots_power10K[[5]]$data
p3 <- plots_power10K[[8]]$data
p4 <- plots_power10K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df4 <- rbind(p1,p2,p3,p4) 
df4$size <- "10000 individuals"

df_all <- rbind(df1,df2,df3,df4)
df_all <- df_all %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df_all$scenario <- factor(df_all$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))

df_all<- df_all %>%
  mutate(
    size = factor(size, levels = c("500 individuals", "2000 individuals", "5000 individuals","10000 individuals"))
  )

latex_labels <- c(
    "500 individuals"="500 individuals",
    "2000 individuals"="2000 individuals",
    "5000 individuals"="5000 individuals",
    "10000 individuals"="10000 individuals",
    "beta[1]" = "hat(beta)[1]",
    "beta[2]" = "hat(beta)[2]",
    "beta[3]" = "hat(beta)[3]"
  )

plot1 <- ggplot(df_all, aes(x = model, y = scenario, fill = power_category)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  scale_fill_viridis_d(option = "D", begin = 0.2, end = 0.85)+
  facet_grid(rows = vars(covariate), cols = vars(size), 
             labeller = labeller(covariate = as_labeller(latex_labels, label_parsed))) +
  labs(
    title = NULL,  
    x = "Model",
    y = "Observation scheme",
    fill = "Power"
  ) + 
  theme_minimal() + 
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),  # Show y-axis labels
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    strip.text = element_text(size = 12,  color = "black"),  # Facet labels in bold
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10),  # Add spacing around the plot
    panel.grid = element_blank(),  
    panel.background = element_blank()  
  )

plot1

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/powertrans2.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```
```{r}
p1 <- plots_power500[[3]]$data
p2 <- plots_power500[[6]]$data
p3 <- plots_power500[[9]]$data
p4 <- plots_power500[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) 
df1$size <- "500 individuals"

p1 <- plots_power2K[[3]]$data
p2 <- plots_power2K[[6]]$data
p3 <- plots_power2K[[9]]$data
p4 <- plots_power2K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) 
df2$size <- "2000 individuals"

p1 <- plots_power5K[[3]]$data
p2 <- plots_power5K[[6]]$data
p3 <- plots_power5K[[9]]$data
p4 <- plots_power5K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) 
df3$size <- "5000 individuals"


p1 <- plots_power10K[[3]]$data
p2 <- plots_power10K[[6]]$data
p3 <- plots_power10K[[9]]$data
p4 <- plots_power10K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df4 <- rbind(p1,p2,p3,p4) 
df4$size <- "10000 individuals"

df_all <- rbind(df1,df2,df3,df4)
df_all <- df_all %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df_all$scenario <- factor(df_all$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))

df_all<- df_all %>%
  mutate(
    size = factor(size, levels = c("500 individuals", "2000 individuals", "5000 individuals","10000 individuals"))
  )

latex_labels <- c(
    "500 individuals"="500 individuals",
    "2000 individuals"="2000 individuals",
    "5000 individuals"="5000 individuals",
    "10000 individuals"="10000 individuals",
    "beta[1]" = "hat(beta)[1]",
    "beta[2]" = "hat(beta)[2]",
    "beta[3]" = "hat(beta)[3]"
  )

plot1 <- ggplot(df_all, aes(x = model, y = scenario, fill = power_category)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  scale_fill_viridis_d(option = "D", begin = 0.2, end = 0.85)+
  facet_grid(rows = vars(covariate), cols = vars(size), 
             labeller = labeller(covariate = as_labeller(latex_labels, label_parsed))) +
  labs(
    title = NULL,  
    x = "Model",
    y = "Observation scheme",
    fill = "Power"
  ) + 
  theme_minimal() + 
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),  # Show y-axis labels
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    strip.text = element_text(size = 12,  color = "black"),  # Facet labels in bold
    legend.position = "top",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10),  # Add spacing around the plot
    panel.grid = element_blank(),  
    panel.background = element_blank()  
  )

plot1

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/powertrans3.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```

### Distribution of estimands associated to covariates

```{r,warning=FALSE, message=FALSE}

latex_labels <- c(
   "beta1" = "hat(beta)[1]",
   "beta2" = "hat(beta)[2]",
   "beta3" = "hat(beta)[3]"
)

create_distr_plot <- function(plot, caption_text) {
  plot + 
    labs(
      title = NULL, 
      caption = caption_text  
    ) + 
    theme(
      axis.title.x = element_text(size = 8, face = "bold"), 
      axis.text.x = element_text(size = 8), 
      axis.text.y = element_text(size = 7), 
      plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"),
      plot.margin = margin(10, 10, 10, 10)  
    )
}

p1 <- create_distr_plot(plots_distr500[[1]][[1]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr500[[2]][[1]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr500[[3]][[1]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr500[[4]][[1]], "irregular observation scheme")

distr_500_trans1 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Dementia",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) 
  )

#
p1 <- create_distr_plot(plots_distr500[[1]][[2]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr500[[2]][[2]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr500[[3]][[2]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr500[[4]][[2]], "irregular observation scheme")

# Combine the plots for transition Dementia-free -> Death
distr_500_trans2 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


p1 <- create_distr_plot(plots_distr500[[1]][[3]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr500[[2]][[3]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr500[[3]][[3]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr500[[4]][[3]], "irregular observation scheme")

# Combine the plots for transition Dementia to Death
distr_500_trans3 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


distr_500_trans1 
distr_500_trans2 
distr_500_trans3 
 


```

transition to dementia scenario 3-6 years
```{r}

latex_labels <- c(
  "transition" = "", 
  "beta1" = "hat(beta)[1]", 
  "beta2" = "hat(beta)[2]", 
  "beta3" = "hat(beta)[3]"
)

# Update p1 with smaller y-axis labels
p1 <- plots_distr500[[1]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "500 individuals")

# Repeat for p2, p3, and p4 (same as p1, with appropriate caption)
p2 <- plots_distr2K[[1]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "2000 individuals")

p3 <- plots_distr5K[[1]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "5000 individuals")

p4 <- plots_distr10K[[1]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "10000 individuals")


final_plot <- (p1 + p2) / (p3 + p4)


ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/coef_distr_trans1.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```

transition from dementia to death
```{r}
latex_labels <- c(
  "transition" = "", 
  "beta1" = "hat(beta)[1]", 
  "beta2" = "hat(beta)[2]", 
  "beta3" = "hat(beta)[3]"
)

# Update p1 with smaller y-axis labels
p1 <- plots_distr500[[3]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8), 
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "500 individuals")

# Repeat for p2, p3, and p4 (same as p1, with appropriate caption)
p2 <- plots_distr2K[[3]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text(size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "2000 individuals")

p3 <- plots_distr5K[[3]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "5000 individuals")

p4 <- plots_distr10K[[3]][[3]] + 
  facet_grid(rows = vars(parameter), 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed))) + 
  theme(
    strip.text = element_text( size = 10),
    plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5),
    axis.text.y = element_text(size = 8) ,
    axis.text.x = element_text(size = 8)  
  ) + 
  labs(title = NULL, x = NULL, caption = "10000 individuals")

# Combine the plots
final_plot <- (p1 + p2) / (p3 + p4)

# Save the plot
ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/coef_distr_trans3.pdf", final_plot, 
       width = 8, height = 6, units = "in", dpi = 300)

```

### Relative Bias of time spent in each state

```{r}
plfe500 + 
  theme(
        axis.text.x = element_text( hjust = 1, size = 10, face="bold"), 
        plot.title = element_text(size = 16, hjust = 0.5, face="bold"),
        strip.text = element_text(size = 13, face="bold") )
```


```{r}
p1 <- plfe500$data
p1$size <- "500 individuals"
p2 <- plfe2K$data
p2$size <- "2000 individuals"
p3 <- plfe5K$data
p3$size <- "5000 individuals"
p4 <- plfe10K$data
p4$size <- "10000 individuals"

lfe_all <- rbind(p1,p2,p3,p4)
lfe_all$dem <- as.factor(lfe_all$dem)
lfe_all$size <- factor(lfe_all$size , levels=c("500 individuals","2000 individuals","5000 individuals","10000 individuals"))
#lfe_all <- lfe_all[lfe_all$scenario=="3 years observation scheme",]
lfe_all <- lfe_all[lfe_all$size== "2000 individuals",]
lfe_all_0 <- lfe_all[lfe_all$dem==0,]
lfe_all_1 <- lfe_all[lfe_all$dem==1,]

pp <- ggplot(lfe_all, aes(x = model, y = lfe_mean, color = dem)) +
  scale_colour_viridis_d(begin = 0.2, end=0.8)+
  geom_point(size = 3) + 
  geom_line(aes(group = dem), size = 1, linetype = "dashed", alpha = 0.8) + 
  #geom_errorbar(aes(ymin = lfe_lower_ci, ymax = lfe_upper_ci), width = 0.2) +  
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  facet_wrap(~ scenario, ncol = 2) +  
  theme_minimal() +  
  theme(
    strip.text = element_text( size = 12), 
    axis.text = element_text(size = 10),  
    legend.title = element_text(size = 12),  
    legend.text = element_text(size = 10),
    legend.position = "top"
  ) +
  labs(title = NULL, 
       x = "Model", 
       y = "Relative Bias(%)", 
       color = "Dementia Onset")

pp2 <- ggplot(lfe_all_1, aes(x = model, y = lfe_mean, color = size)) +
  scale_colour_viridis_d(begin = 0.2, end=0.9)+
  geom_point(size = 3) + 
  geom_line(aes(group = size), size = 1, linetype = "dashed", alpha = 0.8) + 
  #geom_errorbar(aes(ymin = lfe_lower_ci, ymax = lfe_upper_ci), width = 0.2) +  
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  facet_wrap(~ scenario, ncol = 2) +  
  theme_minimal() +  
  theme(
    strip.text = element_text( size = 12), 
    axis.text = element_text(size = 10),  
    legend.title = element_text(size = 12),  
    legend.text = element_text(size = 10),
    legend.position = "top"
  ) +
  labs(title = NULL, 
       x = "Model", 
       y = "Relative Bias(%)", 
       color = "Sample size")

pp
pp2

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/lfe2K.pdf", pp, 
        width = 8, height = 6, units = "in", dpi = 300)
# ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/lfe1_acrosssize.pdf", pp2, 
#         width = 8, height = 6, units = "in", dpi = 300)


```


## Plots: 2K observations

### Bias of estimates

```{r}

p1 <- plots_bias2K[[1]]$data
p2 <- plots_bias2K[[3]]$data
p3 <- plots_bias2K[[5]]$data
p4 <- plots_bias2K[[7]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years "
p3$scenario <- "3-6 years "
p4$scenario <- "irregular "

df_all <- rbind(p1,p2,p3,p4)
latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
  )


 ggplot(data = df_all, aes(x = model, y = bias_mean, color = scenario)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "free", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels))) + 
  
  labs(title = NULL, 
       x = "Model", 
       y = "Bias",
       color = "Observation Scheme") + 
  
  geom_line(aes(group = scenario), linewidth = 1, linetype = "solid", alpha = 0.8) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", size = 1) + 
  
  #geom_errorbar(aes(ymin = bias_lower, ymax = bias_upper), width = 0.3, color = "black") + 

  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14)) + 
  
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)

 ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/bias2K.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```

### Coverage of estimates

```{r, warning=FALSE}
p1 <- plots_cov2K[[1]] + labs(title= "1 year observation scheme")
p2 <- plots_cov2K[[2]] + labs(title= "3 years observation scheme")
p3 <- plots_cov2K[[3]] + labs(title= "3-6 years observation scheme")
p4 <- plots_cov2K[[4]] + labs(title= "irregular observation scheme")

cov_2K <- (p1+p2) / (p3+p4) + plot_layout(guides = "collect")
cov_2K
```

### Error type I in different models

```{r}

p1 <- plots_errorI2K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI2K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI2K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI2K[[4]][[1]]$data
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4)
df1$scenario <- factor(df1$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )

p1 <- plots_errorI2K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI2K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI2K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI2K[[4]][[2]]$data
p4$scenario <- "irregular"


df2 <- rbind(p1,p2,p3,p4)
df2$scenario <- factor(df2$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )


df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))


plot1 <- ggplot(df1, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia-free to Dementia",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
 theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )


plot2 <- ggplot(df2, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia to Death",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  

combined_plot_error2K <- (plot1 | plot2) +plot_layout(guides = 'collect')

combined_plot_error2K & 
  plot_annotation( title = "Type I Error by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))

 
```


### Power of different models

```{r}
p1 <- plots_power2K[[1]]$data
p2 <- plots_power2K[[4]]$data
p3 <- plots_power2K[[7]]$data
p4 <- plots_power2K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) #dementia-free to dem
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power2K[[2]]$data
p2 <- plots_power2K[[5]]$data
p3 <- plots_power2K[[8]]$data
p4 <- plots_power2K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) #dementia-free to death
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power2K[[3]]$data
p2 <- plots_power2K[[6]]$data
p3 <- plots_power2K[[9]]$data
p4 <- plots_power2K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) #dementia to death
df3 <- df3 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df3$scenario <- factor(df3$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))

latex_labels <- c(
  "beta[1]" = "beta[1]",
  "beta[2]" = "beta[2]",
  "beta[3]" = "beta[3]"
)

create_power_plot <- function(data, subtitle){
  ggplot(data, aes(x = model, y = power_category, fill = power_category)) + 
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y = 1)) +  # Add bar borders
  scale_fill_manual(
    values = c(
      "Low (<50%)" = "#E57373",        
      "Moderate (50%-80%)" = "#FFEB3B",       
      "High (>80%)" =  "#8BC34A"      
    )
  ) + 
  facet_grid(
    scenario ~ covariate, 
    labeller = labeller(covariate = as_labeller(latex_labels, label_parsed)),
    switch ="y"
  ) + 
  labs(
    title = "Power by Model and Observation Scheme",
    subtitle = subtitle,
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )
}

plot1 <- create_power_plot(df1, "Transition from Dementia-free to Dementia") 
plot2 <- create_power_plot(df2, "Transition from Dementia-free to Death")
plot3 <- create_power_plot(df3, "Transition from Dementia to Death")

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot3 <- plot3 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  


combined_plot_power2K <- (plot1 | plot2 | plot3) +plot_layout(guides = 'collect')

combined_plot_power2K & 
  plot_annotation( title = "Power by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),panel.spacing = unit(2, "cm")))
```

### Distribution of estimands associated to covariates

```{r,warning=FALSE, message=FALSE}

create_distr_plot <- function(plot, caption_text) {
  plot + 
    labs(
      title = NULL, 
      caption = caption_text  
    ) + 
    theme(
      axis.title.x = element_text(size = 8, face = "bold"), 
      axis.text.x = element_text(size = 8), 
      axis.text.y = element_text(size = 7), 
      plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"),
      plot.margin = margin(10, 10, 10, 10)  
    )
}

p1 <- create_distr_plot(plots_distr2K[[1]][[1]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr2K[[2]][[1]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr2K[[3]][[1]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr2K[[4]][[1]], "irregular observation scheme")

distr_2K_trans1 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Dementia",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) 
  )

#
p1 <- create_distr_plot(plots_distr2K[[1]][[2]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr2K[[2]][[2]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr2K[[3]][[2]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr2K[[4]][[2]], "irregular observation scheme")

# Combine the plots for transition Dementia-free -> Death
distr_2K_trans2 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


p1 <- create_distr_plot(plots_distr2K[[1]][[3]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr2K[[2]][[3]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr2K[[3]][[3]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr2K[[4]][[3]], "irregular observation scheme")

# Combine the plots for transition Dementia to Death
distr_2K_trans3 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


distr_2K_trans1 
distr_2K_trans2 
distr_2K_trans3 
 


```

### Relative Bias of time spent in each state

```{r}
plfe2K  + 
  theme(
        axis.text.x = element_text( hjust = 1, size = 10, face="bold"), 
        plot.title = element_text(size = 16, hjust = 0.5, face="bold"),
        strip.text = element_text(size = 13, face="bold") )
```

## Plots: 5K observations

### Bias of estimates

```{r}

p1 <- plots_bias5K[[1]]$data
p2 <- plots_bias5K[[3]]$data
p3 <- plots_bias5K[[5]]$data
p4 <- plots_bias5K[[7]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years "
p3$scenario <- "3-6 years "
p4$scenario <- "irregular "

df_all <- rbind(p1,p2,p3,p4)
latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
  )


 ggplot(data = df_all, aes(x = model, y = bias_mean, color = scenario)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "free", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels))) + 
  
  labs(title = NULL, 
       x = "Model", 
       y = "Bias",
       color = "Observation Scheme") + 
  
  geom_line(aes(group = scenario), linewidth = 1, linetype = "solid", alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", size = 1) + 
  
  #geom_errorbar(aes(ymin = bias_lower, ymax = bias_upper), width = 0.3, color = "black") + 

  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14)) + 
  
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)
ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/bias5K.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)

 
```

### Coverage of estimates

```{r, warning=FALSE}
p1 <- plots_cov5K[[1]] + labs(title= "1 year observation scheme")
p2 <- plots_cov5K[[2]] + labs(title= "3 years observation scheme")
p3 <- plots_cov5K[[3]] + labs(title= "3-6 years observation scheme")
p4 <- plots_cov5K[[4]] + labs(title= "irregular observation scheme")

cov_5K <- (p1+p2) / (p3+p4) + plot_layout(guides = "collect")
cov_5K
```

### Error type I in different models

```{r}

p1 <- plots_errorI5K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI5K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI5K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI5K[[4]][[1]]$data
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4)
df1$scenario <- factor(df1$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )

p1 <- plots_errorI5K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI5K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI5K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI5K[[4]][[2]]$data
p4$scenario <- "irregular"


df2 <- rbind(p1,p2,p3,p4)
df2$scenario <- factor(df2$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )


df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))


plot1 <- ggplot(df1, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia-free to Dementia",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
 theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )


plot2 <- ggplot(df2, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia to Death",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  

combined_plot_error5K <- (plot1 | plot2) +plot_layout(guides = 'collect')

combined_plot_error5K & 
  plot_annotation( title = "Type I Error by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))

 
```

### Power of different models

```{r}
p1 <- plots_power5K[[1]]$data
p2 <- plots_power5K[[4]]$data
p3 <- plots_power5K[[7]]$data
p4 <- plots_power5K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) #dementia-free to dem
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power5K[[2]]$data
p2 <- plots_power5K[[5]]$data
p3 <- plots_power5K[[8]]$data
p4 <- plots_power5K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) #dementia-free to death
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power5K[[3]]$data
p2 <- plots_power5K[[6]]$data
p3 <- plots_power5K[[9]]$data
p4 <- plots_power5K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) #dementia to death
df3 <- df3 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df3$scenario <- factor(df3$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))

latex_labels <- c(
  "beta[1]" = "beta[1]",
  "beta[2]" = "beta[2]",
  "beta[3]" = "beta[3]"
)

create_power_plot <- function(data, subtitle){
  ggplot(data, aes(x = model, y = power_category, fill = power_category)) + 
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y = 1)) +  # Add bar borders
  scale_fill_manual(
    values = c(
      "Low (<50%)" = "#E57373",        
      "Moderate (50%-80%)" = "#FFEB3B",       
      "High (>80%)" =  "#8BC34A"      
    )
  ) + 
  facet_grid(
    scenario ~ covariate, 
    labeller = labeller(covariate = as_labeller(latex_labels, label_parsed)),
    switch ="y"
  ) + 
  labs(
    title = "Power by Model and Observation Scheme",
    subtitle = subtitle,
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )
}

plot1 <- create_power_plot(df1, "Transition from Dementia-free to Dementia") 
plot2 <- create_power_plot(df2, "Transition from Dementia-free to Death")
plot3 <- create_power_plot(df3, "Transition from Dementia to Death")

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot3 <- plot3 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  


combined_plot_power5K <- (plot1 | plot2 | plot3) +plot_layout(guides = 'collect')

combined_plot_power5K & 
  plot_annotation( title = "Power by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),panel.spacing = unit(2, "cm")))
```

###Distribution of estimands associated to covariates

```{r,warning=FALSE, message=FALSE}

create_distr_plot <- function(plot, caption_text) {
  plot + 
    labs(
      title = NULL, 
      caption = caption_text  
    ) + 
    theme(
      axis.title.x = element_text(size = 8, face = "bold"), 
      axis.text.x = element_text(size = 8), 
      axis.text.y = element_text(size = 7), 
      plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"),
      plot.margin = margin(10, 10, 10, 10)  
    )
}

p1 <- create_distr_plot(plots_distr5K[[1]][[1]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr5K[[2]][[1]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr5K[[3]][[1]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr5K[[4]][[1]], "irregular observation scheme")

distr_5K_trans1 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Dementia",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) 
  )

#
p1 <- create_distr_plot(plots_distr5K[[1]][[2]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr5K[[2]][[2]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr5K[[3]][[2]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr5K[[4]][[2]], "irregular observation scheme")

# Combine the plots for transition Dementia-free -> Death
distr_5K_trans2 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


p1 <- create_distr_plot(plots_distr5K[[1]][[3]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr5K[[2]][[3]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr5K[[3]][[3]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr5K[[4]][[3]], "irregular observation scheme")

# Combine the plots for transition Dementia to Death
distr_5K_trans3 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


distr_5K_trans1 
distr_5K_trans2 
distr_5K_trans3 
 


```

### Relative Bias of time spent in each state

```{r}
plfe5K  + 
  theme(
        axis.text.x = element_text( hjust = 1, size = 10, face="bold"), 
        plot.title = element_text(size = 16, hjust = 0.5, face="bold"),
        strip.text = element_text(size = 13, face="bold") )
```

## Plots: 10K observations

### Bias of estimates

```{r}

p1 <- plots_bias10K[[1]]$data
p2 <- plots_bias10K[[3]]$data
p3 <- plots_bias10K[[5]]$data
p4 <- plots_bias10K[[7]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years "
p3$scenario <- "3-6 years "
p4$scenario <- "irregular "

df_all <- rbind(p1,p2,p3,p4)
latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
  )


 ggplot(data = df_all, aes(x = model, y = bias_mean, color = scenario)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "free", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels))) + 
  
  labs(title = NULL, 
       x = "Model", 
       y = "Bias",
       color = "Observation Scheme") + 
  
  geom_line(aes(group = scenario), linewidth = 1, linetype = "solid", alpha = 0.8) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", size = 1) + 
  
  #geom_errorbar(aes(ymin = bias_lower, ymax = bias_upper), width = 0.3, color = "black") + 

  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14)) + 
  
  scale_color_viridis_d(option = "B", begin = 0.2, end = 0.8)
 ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/bias10K.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)

```

### Coverage of estimates 

```{r, warning=FALSE}
p1 <- plots_cov10K[[1]] + labs(title= "1 year observation scheme")
p2 <- plots_cov10K[[2]] + labs(title= "3 years observation scheme")
p3 <- plots_cov10K[[3]] + labs(title= "3-6 years observation scheme")
p4 <- plots_cov10K[[4]] + labs(title= "irregular observation scheme")

cov_10K <- (p1+p2) / (p3+p4) + plot_layout(guides = "collect")
cov_10K
```

### Error type I in different models

```{r}

p1 <- plots_errorI10K[[1]][[1]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI10K[[2]][[1]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI10K[[3]][[1]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI10K[[4]][[1]]$data
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4)
df1$scenario <- factor(df1$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )

p1 <- plots_errorI10K[[1]][[2]]$data
p1$scenario <- "1 year"
p2 <- plots_errorI10K[[2]][[2]]$data
p2$scenario <- "3 years"
p3 <- plots_errorI10K[[3]][[2]]$data
p3$scenario <- "3-6 years"
p4 <- plots_errorI10K[[4]][[2]]$data
p4$scenario <- "irregular"


df2 <- rbind(p1,p2,p3,p4)
df2$scenario <- factor(df2$scenario, levels = c("1 year", "3 years", "3-6 years", "irregular"))
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<5%)", "Moderate (5%-10%)", "High (>10%)"))
  )


df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))


plot1 <- ggplot(df1, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia-free to Dementia",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
 theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )


plot2 <- ggplot(df2, aes(x = model, y = power_category, fill = power_category,  group = interaction(model, covariate))) +
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y=1)) +  # Aggiungi il bordo nero per le barre
 scale_fill_manual(
    values = c(
      "Low (<5%)" = "#8BC34A",  # Muted olive green
      "Moderate (5%-10%)" = "#FFEB3B",  # Warm golden yellow
      "High (>10%)" = "#E57373"  # Soft coral red
    )
  ) +
  
facet_wrap(~ scenario, ncol = 1, strip.position = "left") + 
  labs(
    title = "Type I Error by Model and Observation Scheme",
    subtitle = "Transition from Dementia to Death",
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  

combined_plot_error10K <- (plot1 | plot2) +plot_layout(guides = 'collect')

combined_plot_error10K & 
  plot_annotation( title = "Type I Error by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)))

 
```

### Power of different models

```{r}
p1 <- plots_power10K[[1]]$data
p2 <- plots_power10K[[4]]$data
p3 <- plots_power10K[[7]]$data
p4 <- plots_power10K[[10]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df1 <- rbind(p1,p2,p3,p4) #dementia-free to dem
df1 <- df1 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power10K[[2]]$data
p2 <- plots_power10K[[5]]$data
p3 <- plots_power10K[[8]]$data
p4 <- plots_power10K[[11]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df2 <- rbind(p1,p2,p3,p4) #dementia-free to death
df2 <- df2 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

p1 <- plots_power10K[[3]]$data
p2 <- plots_power10K[[6]]$data
p3 <- plots_power10K[[9]]$data
p4 <- plots_power10K[[12]]$data

p1$scenario <- "1 year"
p2$scenario <- "3 years"
p3$scenario <- "3-6 years"
p4$scenario <- "irregular"

df3 <- rbind(p1,p2,p3,p4) #dementia to death
df3 <- df3 %>%
  mutate(
    power_category = factor(power_category, levels = c("Low (<50%)", "Moderate (50%-80%)", "High (>80%)"))
  )

df1$scenario <- factor(df1$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df2$scenario <- factor(df2$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))
df3$scenario <- factor(df3$scenario, levels = c("irregular", "3-6 years", "3 years", "1 year"))

latex_labels <- c(
  "beta[1]" = "beta[1]",
  "beta[2]" = "beta[2]",
  "beta[3]" = "beta[3]"
)

create_power_plot <- function(data, subtitle){
  ggplot(data, aes(x = model, y = power_category, fill = power_category)) + 
  geom_bar(stat = "identity", color = "black", position = position_dodge(), aes(y = 1)) +  # Add bar borders
  scale_fill_manual(
    values = c(
      "Low (<50%)" = "#E57373",        
      "Moderate (50%-80%)" = "#FFEB3B",       
      "High (>80%)" =  "#8BC34A"      
    )
  ) + 
  facet_grid(
    scenario ~ covariate, 
    labeller = labeller(covariate = as_labeller(latex_labels, label_parsed)),
    switch ="y"
  ) + 
  labs(
    title = "Power by Model and Observation Scheme",
    subtitle = subtitle,
    x = "Model",
    y = "Observation scheme",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 15)),
    plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 15)),
    axis.text.x = element_text(size = 10, angle = 0, hjust = 1, color = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(size = 12, angle = 0, face = "italic", hjust = 1, color = "black"),
    strip.text.x = element_text(size = 12, face = "italic", color = "black"),
    legend.position = element_blank(),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    legend.key.size = unit(1, "lines"),  # Increase legend key size
    plot.margin = margin(20, 10, 20, 10)  # Add margin around the plot for spacing
  )
}

plot1 <- create_power_plot(df1, "Transition from Dementia-free to Dementia") 
plot2 <- create_power_plot(df2, "Transition from Dementia-free to Death")
plot3 <- create_power_plot(df3, "Transition from Dementia to Death")

plot1 <- plot1 + theme(legend.position = "none", plot.title = element_blank())  
plot3 <- plot3 + theme(legend.position = "none", plot.title = element_blank())  
plot2 <- plot2 + theme(legend.position = "right", plot.title = element_blank())  


combined_plot_power10K <- (plot1 | plot2 | plot3) +plot_layout(guides = 'collect')

combined_plot_power10K & 
  plot_annotation( title = "Power by Model and Observation Scheme",
                   theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),panel.spacing = unit(2, "cm")))
```

### Distribution of estimands associated to covariates

```{r,warning=FALSE, message=FALSE}

create_distr_plot <- function(plot, caption_text) {
  plot + 
    labs(
      title = NULL, 
      caption = caption_text  
    ) + 
    theme(
      axis.title.x = element_text(size = 8, face = "bold"), 
      axis.text.x = element_text(size = 8), 
      axis.text.y = element_text(size = 7), 
      plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"),
      plot.margin = margin(10, 10, 10, 10)  
    )
}

p1 <- create_distr_plot(plots_distr10K[[1]][[1]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr10K[[2]][[1]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr10K[[3]][[1]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr10K[[4]][[1]], "irregular observation scheme")

distr_10K_trans1 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Dementia",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)) 
  )

#
p1 <- create_distr_plot(plots_distr10K[[1]][[2]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr10K[[2]][[2]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr10K[[3]][[2]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr10K[[4]][[2]], "irregular observation scheme")

# Combine the plots for transition Dementia-free -> Death
distr_10K_trans2 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia-free to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


p1 <- create_distr_plot(plots_distr10K[[1]][[3]], "1 year observation scheme")
p2 <- create_distr_plot(plots_distr10K[[2]][[3]], "3 years observation scheme")
p3 <- create_distr_plot(plots_distr10K[[3]][[3]], "3-6 years observation scheme")
p4 <- create_distr_plot(plots_distr10K[[4]][[3]], "irregular observation scheme")

# Combine the plots for transition Dementia to Death
distr_10K_trans3 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(
    title = "Coefficients Density Distribution for Transition Dementia to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5))  
  )


distr_10K_trans1 
distr_10K_trans2 
distr_10K_trans3 
 


```

### Relative Bias of time spent in each state

```{r}
plfe10K  + 
  theme(
        axis.text.x = element_text( hjust = 1, size = 10, face="bold"), 
        plot.title = element_text(size = 16, hjust = 0.5, face="bold"),
        strip.text = element_text(size = 13, face="bold") )
```

## Comparing performances for different samples sizes

### Convergence of different models

```{r}
t1 <- conv_table500 %>%
  select(scheme,model, `Convergence 2`) %>%
  mutate(conv500=`Convergence 2`, `Convergence 2`=NULL)
t2 <- conv_table2K %>%
  select(scheme,model, `Convergence 2`)%>%
  mutate(conv2K=`Convergence 2`, `Convergence 2`=NULL)
t3 <- conv_table5K %>%
  select(scheme,model, `Convergence 2`)%>%
  mutate(conv5K=`Convergence 2`, `Convergence 2`=NULL)
t4 <- conv_table5K %>%
  select(scheme,model, `Convergence 2`)%>%
  mutate(conv10K=`Convergence 2`, `Convergence 2`=NULL)

table_convergence <- full_join(t1,t2)
table_convergence <- full_join(table_convergence,t3)
table_convergence <- full_join(table_convergence,t4)


conv_long <- table_convergence %>%
  pivot_longer(cols = starts_with("conv"), names_to = "sample_size", values_to = "convergence") 
conv_long <- conv_long %>%
    mutate(
      sample_size = case_when(
        sample_size == "conv500" ~ "500 individuals",
        sample_size == "conv2K" ~ "2000 individuals",
        sample_size == "conv5K" ~ "5000 individuals",
        sample_size == "conv10K" ~ "10000 individuals",
      )) %>%
  mutate(
     scheme = case_when(
        scheme == "2" ~ "1 year",
        scheme == "3" ~ "3 years",
        scheme == "4" ~ "3-6 years",
        scheme == "5" ~ "irregular",
        )) %>%
  mutate(sample_size = factor(sample_size, levels = c("500 individuals", "2000 individuals", "5000 individuals", "10000 individuals"))) %>%
  arrange(sample_size, scheme, model)

ggplot(conv_long, aes(x = model, y = scheme, fill = convergence)) +
  geom_tile(color = "white") +
  #geom_text(aes(label = round(convergence, 1)), color = "black", size = 3) +
  facet_wrap(~sample_size) +
  scale_fill_viridis_c(option = "D", begin = 0.1, end = 0.9, name = "Percentage (%)")+
  labs(
    title = NULL,
    x = "Model",
    y = "Observation Scheme"
  ) +
  theme_minimal()+
   theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), 
    legend.position = "top")

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/convergence.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```

### Averaged computational time for different models

```{r}
t1 <- mean_ct500
t2 <- mean_ct2K
t3 <- mean_ct5K
t4 <- mean_ct10K

mean_ct_all <- rbind(t1,t2,t3,t4)
mean_ct_all$sample_size <- rep(1:4, each=4)


mean_ct_all <- mean_ct_all%>%
  pivot_longer(cols=c("a","b","c","d","e","f"),
               names_to = "model",
               values_to = "time")

ggplot(mean_ct_all, aes(x = factor(sample_size, labels = c("500", "2000", "5000", "10000")), 
                        y = time, color = model, group = model)) +
  geom_line(size = 1.2, alpha = 0.7) +
  geom_point(size = 3, alpha = 0.7)+

  facet_wrap(~ scheme, ncol = 2, scales = "fixed") + 
  scale_color_viridis_d() +
  labs(
    title = NULL,
    x = "Sample Size",
    y = "Time (s)",
    color = "Model"
  ) +
  theme_minimal(base_size = 14) + 
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  
  
    axis.title = element_text(size = 14), 
    axis.text = element_text(size = 10),  
    axis.text.x = element_text(angle = 45, hjust = 1), 
    legend.position = "top", 
    legend.title = element_text(size = 12, face = "bold"),  
    legend.text = element_text(size = 10),  
    panel.grid.major = element_line(color = "gray80", linewidth = 0.5),  
    panel.grid.minor = element_blank()  
  )

ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/comp_time.pdf", 
       width = 8, height = 6, units = "in", dpi = 300)
```

### Bias of estimates comparison

```{r}
df_scenario <- function(scenario,title){
  p1 <- plots_bias500[[scenario]]$data
  p2 <- plots_bias2K[[scenario]]$data
  p3 <- plots_bias5K[[scenario]]$data
  p4 <- plots_bias10K[[scenario]]$data
  
  
  p1$size <- "500 observations"
  p2$size <- "2K observations"
  p3$size <- "5K observations"
  p4$size <- "10K observations"
  
  df_all <- rbind(p1,p2,p3,p4)
  df_all$size <- factor(df_all$size, levels = c("500 observations", "2K observations", "5K observations", "10K observations"))
  df_all <- df_all[order(df_all$size), ]
  df_all$scenario <- title
  return(df_all)
}

df_all1 <- df_scenario(1,"1 year")
df_all2 <- df_scenario(3,"3 years")
df_all3 <- df_scenario(5,"3-6 years")
df_all4 <- df_scenario(7,"irregular")

create_plot <- function(df){
  latex_labels <- c(
    "1" = "Transition 1",
    "2" = "Transition 2",
    "3" = "Transition 3",
    "cov1" = "hat(beta)[1]",
    "cov2" = "hat(beta)[2]",
    "cov3" = "hat(beta)[3]"
  )

   
  ggplot(data = df, aes(x = model, y = bias_mean, color = size)) + 
  geom_point(size = 3, shape = 19) + 
  
  facet_grid(parameter ~ transition, scales = "fixed", 
             labeller = labeller(parameter = as_labeller(latex_labels, label_parsed), 
                                 transition = as_labeller(latex_labels)),) + 
  
  labs(title = NULL, 
       x = NULL, 
       y = NULL) + 
  
  geom_line(aes(group = size), size = 1, linetype = "solid", alpha = 0.8) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", size = 1) + 
  theme_bw() + 
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 12), 
        plot.title = element_text(size = 14, hjust = 0.5),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.spacing = unit(1, "lines"),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14)) + 
  
  scale_color_viridis_d(option = "D", begin = 0.2, end = 0.8)
  
}

plot1 <- create_plot(df_all1)+labs(caption = "1 year observation scheme")
plot2 <- create_plot(df_all2)+labs(caption = "3 years observation scheme")
plot3 <- create_plot(df_all3)
plot4 <- create_plot(df_all4)+labs(caption = "irregular observation scheme")

plot3

 # ( plot1+plot2) / (plot3+plot4) + plot_layout(guides = "collect")&
 #  theme(legend.position = "top", 
 #        legend.title = element_text(size = 12), 
 #        legend.text = element_text(size = 10), 
 #        plot.title = element_text(size = 14, hjust = 0.5)) 
 # ylim(0,3)
  ggsave("/Users/AlessandraPescina/OneDrive - Politecnico di Milano/ANNO 5/secondo semestre/TESI/Tesi/Tesi-KI/official_plots/bias_3y.pdf", plot3,
       width = 8, height = 6, units = "in", dpi = 300)

```

### Coverage comparison (1 year)

```{r, warning=FALSE}
p1 <- plots_cov500[[1]] + 
  labs(title =NULL, caption = "500 observations") +
  geom_point(size=0.5)
p2 <- plots_cov2K[[1]] + 
  labs(title= NULL, caption = "2K observations") +
  geom_point(size=0.5)
p3 <- plots_cov5K[[1]] + 
  labs(title= NULL, caption = "5K observations") +
  geom_point(size=0.5)
p4 <- plots_cov10K[[1]] + 
  labs(title= NULL, caption = "10K observations") +
  geom_point(size=0.5)

plots_cov_all <- ( p1+p2) / (p3+p4) +
                 plot_layout(guides = "collect") + 
  plot_annotation(title = "Coverage comparison (1 year)",
    theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)))

plots_cov_all & 
  ylim(0, 100)
```

### Coverage comparison (3-6 years)

```{r, warning=FALSE}
p1 <- plots_cov500[[3]] + 
  labs(title =NULL, caption = "500 observations") +
  geom_point(size=0.5)
p2 <- plots_cov2K[[3]] + 
  labs(title= NULL, caption = "2K observations") +
  geom_point(size=0.5)
p3 <- plots_cov5K[[3]] + 
  labs(title= NULL, caption = "5K observations") +
  geom_point(size=0.5)
p4 <- plots_cov10K[[3]] + 
  labs(title= NULL, caption = "10K observations") +
  geom_point(size=0.5)

plots_cov_all <- ( p1+p2) / (p3+p4) +
                 plot_layout(guides = "collect") + 
  plot_annotation(title = "Coverage comparison (3-6 years)",
    theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5)))

plots_cov_all & 
  ylim(0, 100)
```

### Error type I comparison

```{r, message=FALSE}

plot_error500 <- combined_plot_error500[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle=NULL, caption = "500 observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "right")

plot_error2K <- combined_plot_error2K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "2K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+theme(legend.position = "none")

plot_error5K <- combined_plot_error5K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "5K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+ theme(legend.position = "none")

plot_error10K <- combined_plot_error10K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "10K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

final_combined_plot <- (plot_error500 | plot_error2K) / 
                        (plot_error5K | plot_error10K) + 
                        plot_layout(guides = "collect") + 
                        plot_annotation(
                          title = "Categorised Error type I for transition to Dementia",
                          theme = theme(
                            plot.title = element_text(size = 13, face = "bold", hjust = 0.5)
                          )
                        )
final_combined_plot

plot_error500 <- combined_plot_error500[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle=NULL, caption = "500 observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "right")

plot_error2K <- combined_plot_error2K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "2K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+theme(legend.position = "none")

plot_error5K <- combined_plot_error5K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "5K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+ theme(legend.position = "none")

plot_error10K <- combined_plot_error10K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "10K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

final_combined_plot <- (plot_error500 | plot_error2K) / 
                        (plot_error5K | plot_error10K) + 
                        plot_layout(guides = "collect") + 
                        plot_annotation(
                          title = "Categorised Error type I for transition Dementia to Death",
                          theme = theme(
                            plot.title = element_text(size = 13, face = "bold", hjust = 0.5)
                          )
                        )
final_combined_plot
```

### Power comparison

```{r, message=FALSE}


plot_power500 <- combined_plot_power500[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle=NULL, caption = "500 observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

plot_power2K <- combined_plot_power2K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "2K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+theme(legend.position = "right")

plot_power5K <- combined_plot_power5K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "5K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+ theme(legend.position = "none")

plot_power10K <- combined_plot_power10K[[1]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "10K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

final_combined_plot <- (plot_power500 | plot_power2K) / 
                        (plot_power5K | plot_power10K) + 
                        plot_layout(guides = "collect") + 
                        plot_annotation(
                          title = "Power for transition to Dementia",
                          theme = theme(
                            plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
                            panel.spacing = unit(2, "cm")
                          )
                        )
final_combined_plot

plot_power500 <- combined_plot_power500[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle=NULL, caption = "500 observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "right")

plot_power2K <- combined_plot_power2K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "2K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+theme(legend.position = "none")

plot_power5K <- combined_plot_power5K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "5K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+ theme(legend.position = "none")

plot_power10K <- combined_plot_power10K[[2]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "10K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

final_combined_plot <- (plot_power500 | plot_power2K) / 
                        (plot_power5K | plot_power10K) + 
                        plot_layout(guides = "collect") + 
                        plot_annotation(
                          title = "Power for transition Dementia-free to Death",
                          theme = theme(
                            plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
                            panel.spacing = unit(2, "cm")
                          )
                        )
final_combined_plot

plot_power500 <- combined_plot_power500[[3]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle=NULL, caption = "500 observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

plot_power2K <- combined_plot_power2K[[3]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "2K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+theme(legend.position = "right")

plot_power5K <- combined_plot_power5K[[3]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "5K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold"))+ theme(legend.position = "none")

plot_power10K <- combined_plot_power10K[[3]] +
  labs(y = NULL, x=NULL, title = NULL, subtitle = NULL, caption = "10K observations") +
  theme(plot.caption = element_text(hjust = 0.5, face="bold")) +theme(legend.position = "none")

final_combined_plot <- (plot_power500 | plot_power2K) / 
                        (plot_power5K | plot_power10K) + 
                        plot_layout(guides = "collect") + 
                        plot_annotation(
                          title = "Power for transition Dementia to Death",
                          theme = theme(
                            plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
                            panel.spacing = unit(2, "cm") )
                        )
final_combined_plot
```

### Comparison coefficient distribution (3-6 years)

```{r warning=FALSE, message=FALSE}


latex_labels <- c(
   "cov1" = "hat(beta)[1]",
   "cov2" = "hat(beta)[2]",
   "cov3" = "hat(beta)[3]"
) 
p1 <- plots_distr500[[3]][[1]] + 
  labs(title =NULL, x=NULL, caption = "500 individuals") + theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p2 <- plots_distr2K[[3]][[1]] + 
  labs(title= NULL, x=NULL, caption = "2000 individuals") + theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p3 <- plots_distr5K[[3]][[1]] + 
  labs(title= NULL, x=NULL, caption = "5000 individuals") + theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p4 <- plots_distr10K[[3]][[1]] + 
  labs(title= NULL, x=NULL, caption = "10000 individuals") + theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

plots_distr_all_trans1 <- ( p1+p2) / (p3+p4) +
                 plot_layout(guides = "collect") + 
  plot_annotation(title = NULL,
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)))

p1 <- plots_distr500[[3]][[2]] + 
  labs(title =NULL, x=NULL, caption = "500 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p2 <- plots_distr2K[[3]][[2]] + 
  labs(title= NULL, x=NULL, caption = "2000 individualss") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p3 <- plots_distr5K[[3]][[2]] + 
  labs(title= NULL, x=NULL, caption = "5000 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p4 <- plots_distr10K[[3]][[2]] + 
  labs(title= NULL, x=NULL, caption = "10000 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

plots_distr_all_trans2 <- ( p1+p2) / (p3+p4) +
                 plot_layout(guides = "collect") + 
  plot_annotation(title = "Coefficients distribution for transition Dementia-free to Death",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)))

p1 <- plots_distr500[[3]][[3]] + 
  labs(title =NULL, x=NULL, caption = "500 individuals") + theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p2 <- plots_distr2K[[3]][[3]] + 
  labs(title= NULL, x=NULL, caption = "2000 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p3 <- plots_distr5K[[3]][[3]] + 
  labs(title= NULL, x=NULL, caption = "5000 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))
p4 <- plots_distr10K[[3]][[3]] + 
  labs(title= NULL, x=NULL, caption = "10000 individuals") +theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

plots_distr_all_trans3 <- ( p1+p2) / (p3+p4) +
                 plot_layout(guides = "collect") + 
  plot_annotation(title = "Coefficients distribution for transition Dementia to Death ",
    theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)))

plots_distr_all_trans1
plots_distr_all_trans2
plots_distr_all_trans3
```
```{r}
latex_labels <- c(
   "beta1" = "hat(beta)[1]",
   "beta2" = "hat(beta)[2]",
   "beta3" = "hat(beta)[3]"
)

# Update each plot with x-axis labels
p1 <- plots_distr500[[3]][[1]]+
  labs(title = NULL, x = NULL, caption = "500 individuals") + 
  scale_x_discrete(labels = latex_labels) + 
  theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

p2 <- plots_distr2K[[3]][[1]] + 
  labs(title = NULL, x = NULL, caption = "2000 individuals") + 
  scale_x_discrete(labels = latex_labels) + 
  theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

p3 <- plots_distr5K[[3]][[1]] + 
  labs(title = NULL, x = NULL, caption = "5000 individuals") + 
  scale_x_discrete(labels = latex_labels) + 
  theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

p4 <- plots_distr10K[[3]][[1]] + 
  labs(title = NULL, x = NULL, caption = "10000 individuals") + 
  scale_x_discrete(labels = latex_labels) + 
  theme(plot.caption = element_text(size = 9, hjust = 0.5, vjust = 0.5, face = "bold"))

plots_distr_all_trans1 <- (p1 + p2) / (p3 + p4) + 
  plot_layout(guides = "collect") + 
  plot_annotation(title = NULL, 
                  theme = theme(plot.title = element_text(size = 13, face = "bold", hjust = 0.5)))

# Repeat the same process for the other sets of plots

plots_distr_all_trans1
plots_distr_all_trans2
plots_distr_all_trans3

```


### Relative Bias of time spent in each state (3-6 years obs scheme)

```{r}
df_subset500 <- plfe500$data[plfe500$data$scenario == "3-6 years observation scheme", ]
df_subset2K <- plfe2K$data[plfe2K$data$scenario == "3-6 years observation scheme", ]
df_subset5K <- plfe5K$data[plfe5K$data$scenario == "3-6 years observation scheme", ]
df_subset10K <- plfe10K$data[plfe10K$data$scenario == "3-6 years observation scheme", ]

 df_all <- rbind(
      transform(df_subset500, size = "500 observations"),
      transform(df_subset2K, size = "2K observations"),
      transform(df_subset5K, size = "5K observations"),
      transform(df_subset10K, size = "10K observations")
    )
 df_all$size <- factor(df_all$size, levels = c("500 observations", "2K observations", "5K observations", "10K observations"))
df_all <- df_all[order(df_all$size), ]

  ggplot(df_all, aes(x = model, y = lfe_mean, fill = as.factor(dem))) +
      geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.4) +
      geom_errorbar(aes(ymin = lfe_lower_ci, ymax = lfe_upper_ci),
                    position = position_dodge(width = 0.7), width = 0.25) +
      labs(
        title = "Relative Bias of Time Spent in State for sporadic observation scheme",
        x = NULL,
        y = "Relative Bias (%)",
        fill = NULL
      ) +
      scale_y_continuous(limits = c(-1, 0.7)) +
      scale_fill_manual(values = c("0" = "skyblue", "1" = "purple"),
                        labels = c("Dementia-free", "Dementia")) +
      theme_minimal() +
      theme(
        axis.text.x = element_text( hjust = 1, size = 10, face="bold"), 
        plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),
        legend.position = "top", 
        legend.margin = margin(t = 10),  
        panel.spacing = unit(1, "lines"),
        strip.text = element_text(size = 13, face="bold") 
      ) +
      facet_wrap(~size, ncol = 2)
    
 
```
